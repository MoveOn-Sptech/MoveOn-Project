<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard: Visão geral concessionárias</title>
  <link rel="stylesheet" href="../css/dashboard/visao_geral_concessionaria.css" />
  <link rel="icon" href="../imagens/logo_alternativa_branca.png" />
</head>

<body>
  <nav>
    <span class="logo_nav">
      <a href="./visao-geral-concessionaria.html"><img src="../assets/logo_branca.png" alt="" /></a>
    </span>
    <span class="user_name">
      <p>Monitoramento estratégico - ARTESP</p>
    </span>
    <span class="page_link">
      <p><u>Dashboard</u></p>
    </span>
    <span class="user_icon">
      <img href="../perfil.html" src="../assets/icon/user-dash.png" alt="" />
    </span>
  </nav>

  <h1 class="titulo_dashboard">Visão geral</h1>

  <section class="section_principal">
    <div class="div_container_concessionarias">
      <h2>Concessionárias com mais acidentes</h2>

      <div class="div_pesquisar_concessionarias">
        <p>Pesquisar concessionária:</p>
        <input type="text" placeholder="Digite o nome da concessionária" id="input_nomeConcessionaria"
          onkeydown="filtrarConcessionarias()" onkeyup="filtrarConcessionarias()" />
      </div>

      <div class="div_filtrar">
        <p>Aplicar um filtro:</p>
        <select name="escolherFiltro" id="escolherFiltro" onchange="filtrarConcessionarias()">
          <option value="-9999999">Todas</option>
          <option value="20">Porcentagem maior que 20%</option>
          <option value="40">Porcentagem maior que 40%</option>
          <option value="60">Porcentagem maior que 60%</option>
          <option value="80">Porcentagem maior que 80%</option>
        </select>
      </div>

      <table class="tabela_concessionarias">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Aumento</th>
          </tr>
        </thead>

        <tbody id="tbody">
          <!-- <tr class="negativo tr_concessionaria" onclick="direcionarPaginaConcessionaria(${data.idConcessionaria[i]})">
                        <td>COLINAS</td>
                        <td>+10%</td>
                    </tr>
-->
        </tbody>
      </table>
    </div>

    <div class="div_container_graficos">
      <span class="filter">
        <p class="filtro">Filtro</p>
        <p>Selecione o ano:</p>
        <select name="filtro_ano" id="filtro_ano">
          <option value="2025">2025</option>
          <option value="2025">2024</option>
          <option value="2025">2023</option>
          <option value="2025">2022</option>
          <option value="2025">2021</option>
        </select>
        <p>selecione um intervalo:</p>
        <input type="date" id="input_data_inicio" onchange="onChangeFilterDate()" />
        <p>até</p>
        <input type="date" id="input_data_fim" onchange="onChangeFilterDate()" />
      </span>

      <div class="div_graficos">
        <div class="div_grafico">
          <canvas id="myChart" class="grafico"></canvas>
        </div>

        <div class="div_grafico">
          <canvas id="myChart2" class="grafico"></canvas>
        </div>

        <div class="div_grafico">
          <canvas id="myChart3" class="grafico"></canvas>
        </div>
      </div>
    </div>
  </section>
</body>

</html>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

  const urlParams = new URLSearchParams(window.location.search);

  const dataInicio = urlParams.get("dataInicio");
  const dataFim = urlParams.get("dataFim");

  console.log(dataInicio, dataFim);

  if (
    dataInicio == null ||
    dataInicio == undefined ||
    dataFim == null ||
    dataFim == undefined
  ) {
    window.location.href =
      "./visao-geral-concessionaria.html?dataInicio=2024-01-01&dataFim=2024-12-31";
  }

  function onChangeFilterDate() {
    const dataInicio = document.getElementById("input_data_inicio").value;
    const dataFim = document.getElementById("input_data_fim").value;

    if (dataInicio == "" || dataFim == "") {
      return;
    }

    window.location.href = `./visao-geral-concessionaria.html?dataInicio=${dataInicio}&dataFim=${dataFim}`;
  }

  input_data_inicio.value = dataInicio;
  input_data_fim.value = dataFim;

  function direcionarPaginaConcessionaria(idConcessionaria) {
    window.location.href = `./pagina-concessionaria.html?idConcessionaria=${idConcessionaria}&dataInicio=2024-01-01&dataFim=2024-12-31`;
  }

  let nomeConcessionaria = [];
  let porcentagemDeAumento = [];
  let idConcessionaria = [];


  function filtrarConcessionarias() {

    const nomeFiltro = document.getElementById("input_nomeConcessionaria").value;
    const porcentagemFiltro = document.getElementById("escolherFiltro").value;

    if (nomeFiltro == "" && porcentagemFiltro == "") {
      return;
    }

    const nomeConcessionariaFiltrado = [];
    const porcentagemDeAumentoFiltrado = [];
    const idConcessionariaFiltrado = [];

    for (let i = 0; i < nomeConcessionaria.length; i++) {

      const nomeAtual = nomeConcessionaria[i];

      if (nomeFiltro != "" && porcentagemFiltro != "") {
        if (nomeAtual.toLowerCase().includes(nomeFiltro.toLowerCase()) && porcentagemDeAumento[i] > parseFloat(porcentagemFiltro)) {
          nomeConcessionariaFiltrado.push(nomeAtual);
          porcentagemDeAumentoFiltrado.push(porcentagemDeAumento[i]);
          idConcessionariaFiltrado.push(idConcessionaria[i]);
        }
      } else if (nomeFiltro != "") {
        if (nomeAtual.toLowerCase().includes(nomeFiltro.toLowerCase())) {
          nomeConcessionariaFiltrado.push(nomeAtual);
          porcentagemDeAumentoFiltrado.push(porcentagemDeAumento[i]);
          idConcessionariaFiltrado.push(idConcessionaria[i]);
        }
      } else if (porcentagemFiltro != "") {
        if (porcentagemDeAumento[i] > parseFloat(porcentagemFiltro)) {
          nomeConcessionariaFiltrado.push(nomeAtual);
          porcentagemDeAumentoFiltrado.push(porcentagemDeAumento[i]);
          idConcessionariaFiltrado.push(idConcessionaria[i]);
        }
      }

    }

    renderConcessionarias(nomeConcessionariaFiltrado, porcentagemDeAumentoFiltrado, idConcessionariaFiltrado);

  }

  function renderConcessionarias(nomeConcessionaria, porcentagemDeAumento, idConcessionaria) {
    var tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    for (let i = 0; i < nomeConcessionaria.length; i++) {
      if (porcentagemDeAumento[i] > 0) {
        tbody.innerHTML += `

          <tr class="negativo tr_concessionaria" onclick="direcionarPaginaConcessionaria(${idConcessionaria[i]})">
            <td>${nomeConcessionaria[i]}</td>
            <td>+${porcentagemDeAumento[i]}%</td>
          </tr>

          `

          ;
      } else {
        tbody.innerHTML += `

          <tr class="positivo tr_concessionaria" onclick="direcionarPaginaConcessionaria(${idConcessionaria[i]})">
            <td>${nomeConcessionaria[i]}</td>
            <td>${porcentagemDeAumento[i]}%</td>
          </tr>

          `

          ;
      }
    }
  }

  function pegarConcessionarias() {
    fetch("/visaoGeralConcessionaria/concessionarias", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({}),
    })
      .then((response) => {
        if (response.ok) {
          response.json().then((data) => {
            console.log(data);

            renderConcessionarias(data.nomeConcessionaria, data.porcentagemDeAumento, data.idConcessionaria);
            nomeConcessionaria = data.nomeConcessionaria;
            porcentagemDeAumento = data.porcentagemDeAumento;
            idConcessionaria = data.idConcessionaria;

          });
        } else {
          return response.json().then((data) => {
            throw new Error(data.message || "Erro ao autenticar.");
          });
        }
      })
      .catch((error) => { });
  }

  function pegarMunicipios(dataInicio, dataFim) {
    var vetorMunicipio = [];
    var vetorAcidentes = [];

    fetch(`/visaoGeralConcessionaria/municipios?dataInicio=${dataInicio}&dataFim=${dataFim}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({}),
    })
      .then((response) => {
        if (response.ok) {
          response.json().then((data) => {
            console.log(data);

            vetorMunicipio = data.nomeMunicipios;

            // for (let index = 0; index < vetorMunicipio.length; index++) {
            //     const element = vetorMunicipio[index];
            //     if(element.length > 12){
            //         vetorMunicipio[index] = element.slice(0,7).concat("...")
            //     }
            // }

            vetorAcidentes = data.acidentesMunicipio;

            const ctx = document.getElementById("myChart");

            new Chart(ctx, {
              type: "bar",
              data: {
                labels: vetorMunicipio,
                datasets: [
                  {
                    data: vetorAcidentes,
                    borderWidth: 1,
                    backgroundColor: ["#010358"],
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: 10 },
                plugins: {
                  legend: {
                    display: false,
                  },
                  labels: {
                    font: {
                      size: 10,
                      weight: "bold",
                    },
                  },
                  title: {
                    display: true,
                    text: "Municípios com mais acidentes",
                    font: {
                      size: 20,
                      weight: "bold",
                    },
                    color: "#010358",
                  },
                },
                scales: {
                  x: {
                    // Eixo X
                    ticks: {
                      font: {
                        size: 10, // Define o tamanho da fonte em pixels
                      },
                    },
                  },
                  y: {
                    // Eixo Y
                    ticks: {
                      beginAtZero: true,
                      font: {
                        size: 12,
                      },
                    },
                  },
                },
              },
            });
          });
        } else {
          return response.json().then((data) => {
            throw new Error(data.message || "Erro ao autenticar.");
          });
        }
      })
      .catch((error) => { });
  }

  function pegarRegionalDer(dataInicio, dataFim) {
    var vetorRegionalDer = [];
    var vetorAcidentes = [];

    fetch(`/visaoGeralConcessionaria/regionalDer?dataInicio=${dataInicio}&dataFim=${dataFim}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({}),
    })
      .then((response) => {
        if (response.ok) {
          response.json().then((data) => {
            console.log(data);

            vetorRegionalDer = data.nomeRegionalDer;

            // for (let index = 0; index < vetorMunicipio.length; index++) {
            //     const element = vetorMunicipio[index];
            //     if(element.length > 12){
            //         vetorMunicipio[index] = element.slice(0,7).concat("...")
            //     }
            // }

            vetorAcidentes = data.acidentesRegionalDer;

            const ctx2 = document.getElementById("myChart2");

            new Chart(ctx2, {
              type: "bar",
              data: {
                labels: vetorRegionalDer,
                datasets: [
                  {
                    data: vetorAcidentes,
                    borderWidth: 1,
                    backgroundColor: ["#010358"],
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: 10 },
                plugins: {
                  legend: {
                    display: false,
                  },
                  labels: {
                    font: {
                      size: 10,
                      weight: "bold",
                    },
                  },
                  title: {
                    display: true,
                    text: "Regional DER com mais acidentes",
                    font: {
                      size: 20,
                      weight: "bold",
                    },
                    color: "#010358",
                  },
                },
                scales: {
                  x: {
                    // Eixo X
                    ticks: {
                      font: {
                        size: 10, // Define o tamanho da fonte em pixels
                      },
                    },
                  },
                  y: {
                    // Eixo Y
                    ticks: {
                      beginAtZero: true,
                      font: {
                        size: 12,
                      },
                    },
                  },
                },
              },
            });
          });
        } else {
          return response.json().then((data) => {
            throw new Error(data.message || "Erro ao autenticar.");
          });
        }
      })
      .catch((error) => { });
  }

  function pegarRegionalAdm(dataInicio, dataFim) {
    var vetorRegionalAdm = [];
    var vetorAcidentes = [];

    fetch(`/visaoGeralConcessionaria/regionalAdm?dataInicio=${dataInicio}&dataFim=${dataFim}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({}),
    })
      .then((response) => {
        if (response.ok) {
          response.json().then((data) => {
            console.log(data);

            vetorRegionalAdm = data.nomeRegionalAdm;

            // for (let index = 0; index < vetorMunicipio.length; index++) {
            //     const element = vetorMunicipio[index];
            //     if(element.length > 12){
            //         vetorMunicipio[index] = element.slice(0,7).concat("...")
            //     }
            // }

            vetorAcidentes = data.acidentesRegionalAdm;

            const ctx3 = document.getElementById("myChart3");

            new Chart(ctx3, {
              type: "bar",
              data: {
                labels: vetorRegionalAdm,
                datasets: [
                  {
                    data: vetorAcidentes,
                    borderWidth: 1,
                    backgroundColor: ["#010358"],
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: 10 },
                plugins: {
                  legend: {
                    display: false,
                  },
                  labels: {
                    font: {
                      size: 10,
                      weight: "bold",
                    },
                  },
                  title: {
                    display: true,
                    text: "Regional ADM com mais acidentes",
                    font: {
                      size: 20,
                      weight: "bold",
                    },
                    color: "#010358",
                  },
                },
                scales: {
                  x: {
                    // Eixo X
                    ticks: {
                      font: {
                        size: 10, // Define o tamanho da fonte em pixels
                      },
                    },
                  },
                  y: {
                    // Eixo Y
                    ticks: {
                      beginAtZero: true,
                      font: {
                        size: 12,
                      },
                    },
                  },
                },
              },
            });
          });
        } else {
          return response.json().then((data) => {
            throw new Error(data.message || "Erro ao autenticar.");
          });
        }
      })
      .catch((error) => { });
  }

  pegarMunicipios(dataInicio, dataFim);
  pegarRegionalDer(dataInicio, dataFim);
  pegarRegionalAdm(dataInicio, dataFim);
  pegarConcessionarias();

</script>