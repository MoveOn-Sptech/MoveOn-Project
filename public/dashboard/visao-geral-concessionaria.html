<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard: Visão geral concessionárias</title>
  <link rel="stylesheet" href="../css/dashboard/visao_geral_concessionaria.css" />
  <link rel="icon" href="../imagens/logo_alternativa_branca.png" />
</head>

<body>

  <nav>
    <span class="logo_nav">
      <a href="visao-geral-rodovia.html"><img src="../assets/logo_branca.png" alt=""></a>
    </span>
    <span class="user_name">
      <p>Estratégico - ARTESP</p>
    </span>
    <span class="user_icon">
      <a href="../perfil.html"><img src="../assets/icon/user-dash.png" alt=""></a>
    </span>
  </nav>

  <h1 class="titulo_dashboard">Visão geral</h1>

  <section class="section_principal">
    <div class="div_container_concessionarias">
      <div class="titles">
        <h2>Concessionárias com mais acidentes</h2>

        <h4>
          Comparação de <span id="span_mes_atual"></span> para
          <span id="span_mes_anterior"></span>
        </h4>
      </div>

      <div class="div_pesquisar_concessionarias">
        <p>Pesquisar concessionária:</p>
        <input type="text" placeholder="Digite o nome da concessionária" id="input_nomeConcessionaria"
          onkeydown="filtrarConcessionarias()" onkeyup="filtrarConcessionarias()" />
      </div>

      <div class="div_filtrar">
        <p>Aplicar um filtro:</p>
        <select name="escolherFiltro" id="escolherFiltro" onchange="filtrarConcessionarias()">
          <option value="-9999999">Todas</option>
          <option value="20">Porcentagem maior que 20%</option>
          <option value="40">Porcentagem maior que 40%</option>
          <option value="60">Porcentagem maior que 60%</option>
          <option value="80">Porcentagem maior que 80%</option>
        </select>
      </div>

      <table class="tabela_concessionarias">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Aumento</th>
          </tr>
        </thead>

        <tbody id="tbody">
          <!-- <tr class="negativo tr_concessionaria" onclick="direcionarPaginaConcessionaria(${data.idConcessionaria[i]})">
                        <td>COLINAS</td>
                        <td>+10%</td>
                    </tr>
-->
        </tbody>
      </table>
    </div>

    <div class="div_container_graficos">
      <span class="filter">
        <p class="filtro">Filtro</p>
        <p>Selecione o ano:</p>
        <select name="filtro_ano" id="filtro_ano" onchange="onChangeFilterDate()">
          <option value="2024">2024</option>
          <option value="2023">2023</option>
          <option value="2022">2022</option>
          <option value="2021">2021</option>
          <option value="2020">2020</option>
        </select>
        <p>selecione um intervalo:</p>
        <input type="date" id="input_data_inicio" onchange="onChangeFilterDate()" />
        <p>até</p>
        <input type="date" id="input_data_fim" onchange="onChangeFilterDate()" />
      </span>

      <div class="div_graficos">
        <div class="div_grafico">
          <canvas id="myChart" class="grafico"></canvas>
        </div>

        <div class="div_grafico">
          <canvas id="myChart2" class="grafico"></canvas>
        </div>

        <div class="div_grafico">
          <canvas id="myChart3" class="grafico"></canvas>
        </div>
      </div>
    </div>
  </section>
</body>

</html>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const urlParams = new URLSearchParams(window.location.search);

  const dataInicio = urlParams.get("dataInicio");
  const dataFim = urlParams.get("dataFim");

  console.log(dataInicio, dataFim);

  if (
    dataInicio == null ||
    dataInicio == undefined ||
    dataFim == null ||
    dataFim == undefined
  ) {
    window.location.href =
      "./visao-geral-concessionaria.html?dataInicio=2024-01-01&dataFim=2024-12-31";
  }

  function onChangeFilterDate() {
    const ano = document.getElementById("filtro_ano").value;

    if (ano == "") {
      return;
    }

    let dataInicio = document.getElementById("input_data_inicio").value;
    let dataFim = document.getElementById("input_data_fim").value;

    if (dataInicio == "" || dataFim == "") {
      return;
    }

    dataInicio = `${ano}-${dataInicio.slice(5, 10)}`;

    dataFim = `${ano}-${dataFim.slice(5, 10)}`;

    window.location.href = `./visao-geral-concessionaria.html?dataInicio=${dataInicio}&dataFim=${dataFim}`;
  }

  input_data_inicio.value = dataInicio;
  input_data_fim.value = dataFim;
  filtro_ano.value = dataInicio.slice(0, 4);

  const mapMeses = {
    "01": "Janeiro",
    "02": "Fevereiro",
    "03": "Março",
    "04": "Abril",
    "05": "Maio",
    "06": "Junho",
    "07": "Julho",
    "08": "Agosto",
    "09": "Setembro",
    10: "Outubro",
    11: "Novembro",
    12: "Dezembro",
  };

  span_mes_atual.innerText = mapMeses[dataFim.slice(5, 7)];
  span_mes_anterior.innerText =
    mapMeses[String(parseInt(dataFim.slice(5, 7)) - 1).padStart(2, "0")];

  function direcionarPaginaConcessionaria(
    idConcessionaria,
    nomeConcessionaria
  ) {
    window.location.href = `./pagina-concessionaria.html?idConcessionaria=${idConcessionaria}&nomeConcessionaria=${nomeConcessionaria}&dataInicio=${dataInicio}&dataFim=${dataFim}`;
  }

  let nomeConcessionaria = [];
  let porcentagemDeAumento = [];
  let idConcessionaria = [];

  function filtrarConcessionarias() {
    const nomeFiltro = document.getElementById(
      "input_nomeConcessionaria"
    ).value;
    const porcentagemFiltro = document.getElementById("escolherFiltro").value;

    if (nomeFiltro == "" && porcentagemFiltro == "") {
      return;
    }

    const nomeConcessionariaFiltrado = [];
    const porcentagemDeAumentoFiltrado = [];
    const idConcessionariaFiltrado = [];

    for (let i = 0; i < nomeConcessionaria.length; i++) {
      const nomeAtual = nomeConcessionaria[i];

      if (nomeFiltro != "" && porcentagemFiltro != "") {
        if (
          nomeAtual.toLowerCase().includes(nomeFiltro.toLowerCase()) &&
          Math.abs(porcentagemDeAumento[i]) > parseFloat(porcentagemFiltro)
        ) {
          nomeConcessionariaFiltrado.push(nomeAtual);
          porcentagemDeAumentoFiltrado.push(porcentagemDeAumento[i]);
          idConcessionariaFiltrado.push(idConcessionaria[i]);
        }
      } else if (nomeFiltro != "") {
        if (nomeAtual.toLowerCase().includes(nomeFiltro.toLowerCase())) {
          nomeConcessionariaFiltrado.push(nomeAtual);
          porcentagemDeAumentoFiltrado.push(porcentagemDeAumento[i]);
          idConcessionariaFiltrado.push(idConcessionaria[i]);
        }
      } else if (porcentagemFiltro != "") {
        if (Math.abs(porcentagemDeAumento[i]) > parseFloat(porcentagemFiltro)) {
          nomeConcessionariaFiltrado.push(nomeAtual);
          porcentagemDeAumentoFiltrado.push(porcentagemDeAumento[i]);
          idConcessionariaFiltrado.push(idConcessionaria[i]);
        }
      }
    }

    renderConcessionarias(
      nomeConcessionariaFiltrado,
      porcentagemDeAumentoFiltrado,
      idConcessionariaFiltrado
    );
  }

  function renderConcessionarias(
    nomeConcessionaria,
    porcentagemDeAumento,
    idConcessionaria
  ) {
    var tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    for (let i = 0; i < nomeConcessionaria.length; i++) {
      if (porcentagemDeAumento[i] > 0) {
        tbody.innerHTML += `

            <tr class="positivo tr_concessionaria" onclick="direcionarPaginaConcessionaria(${idConcessionaria[i]}, '${nomeConcessionaria[i]}')">
              <td>${nomeConcessionaria[i]}</td>
              <td>-${porcentagemDeAumento[i]}%</td>
            </tr>

            `;
      } else {
        if (porcentagemDeAumento[i] == 0.0) {
          tbody.innerHTML += `

            <tr class="positivo tr_concessionaria" onclick="direcionarPaginaConcessionaria(${idConcessionaria[i]}, '${nomeConcessionaria[i]}')">
              <td>${nomeConcessionaria[i]}</td>
              <td>0%</td>
            </tr>

            `;
        } else {
          tbody.innerHTML += `

            <tr class="negativo tr_concessionaria" onclick="direcionarPaginaConcessionaria(${idConcessionaria[i]
            }, '${nomeConcessionaria[i]}')">
              <td>${nomeConcessionaria[i]}</td>
              <td>+${new String(porcentagemDeAumento[i]).slice(1, 5)}%</td>
            </tr>

            `;
        }
      }
    }
  }

  function pegarConcessionarias() {
    fetch(
      `/visaoGeralConcessionaria/concessionarias?dataInicio=${dataInicio}&dataFim=${dataFim}`,
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({}),
      }
    )
      .then((response) => {
        if (response.ok) {
          response.json().then((data) => {
            console.log(data);

            renderConcessionarias(
              data.nomeConcessionaria,
              data.porcentagemDeAumento,
              data.idConcessionaria
            );
            nomeConcessionaria = data.nomeConcessionaria;
            porcentagemDeAumento = data.porcentagemDeAumento;
            idConcessionaria = data.idConcessionaria;
          });
        } else {
          return response.json().then((data) => {
            throw new Error(data.message || "Erro ao autenticar.");
          });
        }
      })
      .catch((error) => { });
  }

  function pegarMunicipios(dataInicio, dataFim) {
    var vetorMunicipio = [];
    var vetorAcidentes = [];

    fetch(
      `/visaoGeralConcessionaria/municipios?dataInicio=${dataInicio}&dataFim=${dataFim}`,
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({}),
      }
    )
      .then((response) => {
        if (response.ok) {
          response.json().then((data) => {
            console.log(data);

            vetorMunicipio = data.nomeMunicipios;

            // for (let index = 0; index < vetorMunicipio.length; index++) {
            //     const element = vetorMunicipio[index];
            //     if(element.length > 12){
            //         vetorMunicipio[index] = element.slice(0,7).concat("...")
            //     }
            // }

            vetorAcidentes = data.acidentesMunicipio;

            const ctx = document.getElementById("myChart");
            const vetorMunicipioReduzido = vetorMunicipio.map((municipio) => {
              if (municipio.length > 10) {
                return municipio.slice(0, 7).concat("...");
              }
              return municipio;
            });

            new Chart(ctx, {
              type: "bar",
              data: {
                labels: vetorMunicipioReduzido, // reduzido só para exibição
                datasets: [
                  {
                    data: vetorAcidentes,
                    borderWidth: 1,
                    backgroundColor: ["#010358"],
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: 10 },
                plugins: {
                  legend: {
                    display: false,
                  },
                  title: {
                    display: true,
                    text: `Municípios com mais acidentes (${dataInicio.slice(
                      5,
                      7
                    )}/${dataInicio.slice(0, 4)} até ${dataFim.slice(
                      5,
                      7
                    )}/${dataFim.slice(0, 4)})`,
                    font: {
                      size: 20,
                      weight: "bold",
                    },
                    color: "#010358",
                  },
                  tooltip: {
                    callbacks: {
                      // aqui você mostra o nome completo
                      title: function (context) {
                        const index = context[0].dataIndex;
                        return vetorMunicipio[index]; // usa o vetor original
                      },
                      label: function (context) {
                        return "Acidentes: " + context.formattedValue;
                      },
                    },
                  },
                },
                scales: {
                  x: {
                    ticks: {
                      font: {
                        size: 10,
                      },
                    },
                  },
                  y: {
                    ticks: {
                      beginAtZero: true,
                      font: {
                        size: 12,
                      },
                    },
                  },
                },
              },
            });
          });
        } else {
          return response.json().then((data) => {
            throw new Error(data.message || "Erro ao autenticar.");
          });
        }
      })
      .catch((error) => { });
  }

  function pegarRegionalDer(dataInicio, dataFim) {
    var vetorRegionalDer = [];
    var vetorAcidentes = [];

    fetch(
      `/visaoGeralConcessionaria/regionalDer?dataInicio=${dataInicio}&dataFim=${dataFim}`,
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({}),
      }
    )
      .then((response) => {
        if (response.ok) {
          response.json().then((data) => {
            console.log(data);

            vetorRegionalDer = data.nomeRegionalDer;

            // for (let index = 0; index < vetorMunicipio.length; index++) {
            //     const element = vetorMunicipio[index];
            //     if(element.length > 12){
            //         vetorMunicipio[index] = element.slice(0,7).concat("...")
            //     }
            // }

            vetorAcidentes = data.acidentesRegionalDer;

            const ctx2 = document.getElementById("myChart2");

            const vetorRegionalDerReduzido = vetorRegionalDer.map(
              (regional) => {
                if (regional.length > 10) {
                  return regional.slice(0, 7).concat("...");
                }
                return regional;
              }
            );

            new Chart(ctx2, {
              type: "bar",
              data: {
                labels: vetorRegionalDerReduzido, // reduzido só para exibição
                datasets: [
                  {
                    data: vetorAcidentes,
                    borderWidth: 1,
                    backgroundColor: ["#010358"],
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: 10 },
                plugins: {
                  legend: {
                    display: false,
                  },
                  title: {
                    display: true,
                    text: `Regional DER com mais acidentes (${dataInicio.slice(
                      5,
                      7
                    )}/${dataInicio.slice(0, 4)} até ${dataFim.slice(
                      5,
                      7
                    )}/${dataFim.slice(0, 4)})`,
                    font: {
                      size: 20,
                      weight: "bold",
                    },
                    color: "#010358",
                  },
                  tooltip: {
                    callbacks: {
                      // Mostra o nome completo no tooltip
                      title: function (context) {
                        const index = context[0].dataIndex;
                        return vetorRegionalDer[index]; // usa o vetor original
                      },
                      label: function (context) {
                        return "Acidentes: " + context.formattedValue;
                      },
                    },
                  },
                },
                scales: {
                  x: {
                    ticks: {
                      font: {
                        size: 10,
                      },
                    },
                  },
                  y: {
                    ticks: {
                      beginAtZero: true,
                      font: {
                        size: 12,
                      },
                    },
                  },
                },
              },
            });
          });
        } else {
          return response.json().then((data) => {
            throw new Error(data.message || "Erro ao autenticar.");
          });
        }
      })
      .catch((error) => { });
  }

  function pegarRegionalAdm(dataInicio, dataFim) {
    var vetorRegionalAdm = [];
    var vetorAcidentes = [];

    fetch(
      `/visaoGeralConcessionaria/regionalAdm?dataInicio=${dataInicio}&dataFim=${dataFim}`,
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({}),
      }
    )
      .then((response) => {
        if (response.ok) {
          response.json().then((data) => {
            console.log(data);

            vetorRegionalAdm = data.nomeRegionalAdm;

            // for (let index = 0; index < vetorMunicipio.length; index++) {
            //     const element = vetorMunicipio[index];
            //     if(element.length > 12){
            //         vetorMunicipio[index] = element.slice(0,7).concat("...")
            //     }
            // }

            vetorAcidentes = data.acidentesRegionalAdm;

            const ctx3 = document.getElementById("myChart3");

            const dataInicioFormatada = Intl.DateTimeFormat("pt-BR").format(
              new Date(dataInicio)
            );

            const dataFimFormatada = Intl.DateTimeFormat("pt-BR").format(
              new Date(dataFim)
            );

            const vetorRegionalAdmReduzido = vetorRegionalAdm.map(
              (regional) => {
                if (regional.length > 10) {
                  return regional.slice(0, 7).concat("...");
                }
                return regional;
              }
            );

            new Chart(ctx3, {
              type: "bar",
              data: {
                labels: vetorRegionalAdmReduzido, // reduzido só para exibição
                datasets: [
                  {
                    data: vetorAcidentes,
                    borderWidth: 1,
                    backgroundColor: ["#010358"],
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: 10 },
                plugins: {
                  legend: {
                    display: false,
                  },
                  title: {
                    display: true,
                    text: `Regional ADM com mais acidentes (${dataInicio.slice(
                      5,
                      7
                    )}/${dataInicio.slice(0, 4)} até ${dataFim.slice(
                      5,
                      7
                    )}/${dataFim.slice(0, 4)})`,
                    font: {
                      size: 20,
                      weight: "bold",
                    },
                    color: "#010358",
                  },
                  tooltip: {
                    callbacks: {
                      // Mostra o nome completo no tooltip
                      title: function (context) {
                        const index = context[0].dataIndex;
                        return vetorRegionalAdm[index]; // usa o vetor original
                      },
                      label: function (context) {
                        return "Acidentes: " + context.formattedValue;
                      },
                    },
                  },
                },
                scales: {
                  x: {
                    ticks: {
                      font: {
                        size: 10,
                      },
                    },
                  },
                  y: {
                    ticks: {
                      beginAtZero: true,
                      font: {
                        size: 12,
                      },
                    },
                  },
                },
              },
            });
          });
        } else {
          return response.json().then((data) => {
            throw new Error(data.message || "Erro ao autenticar.");
          });
        }
      })
      .catch((error) => { });
  }

  pegarMunicipios(dataInicio, dataFim);
  pegarRegionalDer(dataInicio, dataFim);
  pegarRegionalAdm(dataInicio, dataFim);
  pegarConcessionarias();
</script>