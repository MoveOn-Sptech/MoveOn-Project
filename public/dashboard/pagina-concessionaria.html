<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard: Concessionária</title>
    <link rel="stylesheet" href="../css/dashboard/concessionaria.css" />
    <link rel="icon" href="../imagens/logo_alternativa_branca.png" />
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>

  <body>
    <nav>
      <span class="logo_nav">
        <a href="./visao-geral-concessionaria.html"
          ><img src="../assets/logo_branca.png" alt=""
        /></a>
      </span>
      <span class="user_name">
        <p>Monitoramento Estratégico - ARTESP</p>
      </span>
      <span class="page_link">
        <p><u>Dashboard</u></p>
      </span>
      <span class="user_icon">
        <img href="../perfil.html" src="../assets/icon/user-dash.png" alt="" />
      </span>
    </nav>

    <h1 class="titulo_dashboard">
      Concessionária: <span id="span_nome_concessionaria"></span>
    </h1>

    <section class="section_principal">
      <div class="div_container_concessionarias">
        <div class="titles">
          <h2>Rodovias com mais acidentes</h2>
          <h4>
            <span id="span_inicio_data"> </span>

            <span id="span_fim_data"> </span>
          </h4>
        </div>

        <div class="div_pesquisar_concessionarias">
          <p>Pesquisar rodovia:</p>
          <input
            type="text"
            placeholder="Digite o nome da rodovia"
            id="input_nome"
            onkeydown="onChangeSelectedFilter()"
            onkeyup="onChangeSelectedFilter()"
          />
        </div>

        <div class="div_filtrar">
          <p>Aplicar um filtro:</p>
          <select
            name="escolherFiltro"
            id="escolherFiltro"
            onchange="onChangeSelectedFilter()"
          >
            <option value="-1" onclick="allRodovias()">Todos</option>
          </select>
        </div>

        <table class="tabela_concessionarias">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Quantidade</th>
            </tr>
          </thead>

          <tbody id="rodovias-tbody"></tbody>
        </table>

        <div class="div_btn">
          <button class="btn_gerarRelatorio" onclick="gerarRelatorio()">
            Gerar relatório
          </button>
        </div>
      </div>

      <div class="div_container_graficos">
        <span class="filter">
          <p class="filtro">Filtro</p>
          <p>Selecione o ano:</p>
          <select name="select_filtro_ano" id="select_filtro_ano">
            <option value="2025">2025</option>
            <option value="2024">2024</option>
            <option value="2023">2023</option>
            <option value="2022">2022</option>
            <option value="2021">2021</option>
          </select>
          <p>selecione um intervalo:</p>
          <input
            type="date"
            id="input_data_inicio"
            onchange="onChangeFilterDate()"
          />
          <p>até</p>
          <input
            type="date"
            id="input_data_fim"
            onchange="onChangeFilterDate()"
          />
        </span>

        <div class="div_graficos">
          <div class="div_grafico">
            <canvas id="myChart4" class="grafico"></canvas>
          </div>

          <div class="graficos_pizza">
            <div>
              <canvas id="myChart2" class="grafico"></canvas>
            </div>

            <div>
              <canvas id="myChart3" class="grafico"></canvas>
            </div>
          </div>

          <div class="div_grafico">
            <canvas id="myChart" class="grafico"></canvas>
          </div>
        </div>
      </div>
    </section>
  </body>
</html>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  function gerarRelatorio() {
    const urlParams = new URLSearchParams(window.location.search);

    const fkConcessionaria = urlParams.get("idConcessionaria");
    console.log("fkConcessionaria " + fkConcessionaria);
    const email = sessionStorage.getItem("emailUsuario");

    console.log("email " + email);

    console.log(fkConcessionaria);
    console.log(input_data_inicio.value, input_data_fim.value);
    fetch(
      `/concessionaria/gerar-relatorio?fkConcessionaria=${fkConcessionaria}&email=${email}&dataInicio=${
        input_data_inicio.value
      }&dataFim=${input_data_fim.value}&concessionaria=${
        span_nome_concessionaria.innerText
      }&responsavel=${sessionStorage.getItem(
        "nomeUsuario"
      )}&fkUsuario=${sessionStorage.getItem("idUsuario")}`
    ).then((response) => {
      response.json().then((data) => {
        console.log(data);

        Swal.fire({
          icon: "success",
          title: "Relatório gerado com sucesso!",
          text: "Verifique seu email no slack.",
        });
      });
    });
  }

  function onChangeFilterDate() {
    const dataInicio = document.getElementById("input_data_inicio").value;
    const dataFim = document.getElementById("input_data_fim").value;

    if (dataInicio == "" || dataFim == "") {
      return;
    }

    console.log(dataInicio, dataFim);
    window.location.href = `./pagina-concessionaria.html?idConcessionaria=${fkConcessionaria}&dataInicio=${dataInicio}&dataFim=${dataFim}&nomeConcessionaria=${span_nome_concessionaria.innerText}`;
  }

  function onChangeSelectedFilter() {
    const selectedFilter = document.getElementById("escolherFiltro").value;

    console.log(selectedFilter);

    const rodoviasFiltradas = todasRodovia.filter((rodovia) => {
      if (input_nome.value != "") {
        return (
          rodovia.nomeRodovia
            .toLowerCase()
            .includes(input_nome.value.toLowerCase()) &&
          rodovia.quantidade >= parseInt(selectedFilter)
        );
      }

      return rodovia.quantidade >= parseInt(selectedFilter);
    });

    renderRodovias(rodoviasFiltradas);
  }

  function allRodovias() {
    renderRodovias(todasRodovia);
  }

  function direcionarPaginaRodovia() {
    window.location.href = "./pagina-rodovia.html";
  }

  const urlParams = new URLSearchParams(window.location.search);

  const fkConcessionaria = urlParams.get("idConcessionaria");

  const nomeConcessionariaSpan = urlParams.get("nomeConcessionaria");

  span_nome_concessionaria.innerText = nomeConcessionariaSpan;

  const dataInicio = urlParams.get("dataInicio");
  const dataFim = urlParams.get("dataFim");

  if (
    fkConcessionaria == undefined ||
    fkConcessionaria == null ||
    dataInicio == null ||
    dataInicio == undefined ||
    dataFim == null ||
    dataFim == undefined
  ) {
    window.location.href =
      "./pagina-concessionaria.html?idConcessionaria=1&dataInicio=2024-01-01&dataFim=2024-12-31&nomeConcessionaria=SPVIAS";
  }

  input_data_inicio.value = dataInicio;
  input_data_fim.value = dataFim;

  const dataInicioFormatada = Intl.DateTimeFormat("pt-BR").format(
    new Date(dataInicio)
  );

  const dataFimFormatada = Intl.DateTimeFormat("pt-BR").format(
    new Date(dataFim)
  );

  span_inicio_data.innerText = `De: ${dataInicioFormatada}`;
  span_fim_data.innerText = ` Até: ${dataFimFormatada}`;

  select_filtro_ano.value = dataInicio.split("-")[0];

  const todasRodovia = [];

  function renderRodovias(rodovias) {
    const rodoviasBody = document.getElementById("rodovias-tbody");
    let text = "";

    const filterBody = document.getElementById("escolherFiltro");

    if (rodovias.length === todasRodovia.length) {
    }

    rodovias.forEach((rodovia) => {
      text += `
          <tr class="tr_rodovia" onclick="direcionarPaginaRodovia()">
              <td>${rodovia.nomeRodovia}</td>
              <td>${rodovia.quantidade}</td>
          </tr>
      `;
    });

    rodoviasBody.innerHTML = text;
  }

  fetch(
    `/concessionaria/rodoviaComMaisAcidente?fkConcessionaria=${fkConcessionaria}&dataInicio=${dataInicio}&dataFim=${dataFim}`
  ).then((response) => {
    response.json().then((data) => {
      todasRodovia.push(...data);

      renderRodovias(data);

      const ctx = document.getElementById("myChart");
      const labels = data.map((rodovia) => rodovia.nomeRodovia);
      const quantidade = data.map((rodovia) => rodovia.quantidade);

      const maiorQuantidade = Math.max(...quantidade);

      if (maiorQuantidade > 50) {
        escolherFiltro.innerHTML += `
       <option value="50" onclick="onChangeSelectedFilter()">
              Rodovias com 50+ acidentes
            </option>
        `;
      }

      if (maiorQuantidade > 100) {
        escolherFiltro.innerHTML += `
       <option value="100" onclick="onChangeSelectedFilter()">
              Rodovias com 100+ acidentes
            </option>
        `;
      }

      if (maiorQuantidade > 500) {
        escolherFiltro.innerHTML += `
       <option value="500" onclick="onChangeSelectedFilter()">
              Rodovias com 500+ acidentes
            </option>
        `;
      }

      if (maiorQuantidade > 1000) {
        escolherFiltro.innerHTML += `
       <option value="1000" onclick="onChangeSelectedFilter()">
              Rodovias com 1000+ acidentes
            </option>
        `;
      }

      new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels.slice(0, 10),
          datasets: [
            {
              data: quantidade.slice(0, 10),
              borderWidth: 1,
              backgroundColor: ["#010358"],
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: 10 },
          plugins: {
            legend: {
              display: false,
            },
            title: {
              display: true,
              text: "Rodovias com mais acidentes",
              font: {
                size: 20,
                weight: "bold",
              },
              color: "#010358",
            },
          },
          scales: {
            y: {
              beginAtZero: true,
            },
          },
        },
      });
    });
  });

  fetch(
    `/concessionaria/acidentePorMes?fkConcessionaria=${fkConcessionaria}&dataInicio=${dataInicio}&dataFim=${dataFim}`
  ).then((response) => {
    response.json().then((anoAtual) => {
      let dataInicioAnoAnterior = new Date(dataInicio);
      dataInicioAnoAnterior.setFullYear(
        dataInicioAnoAnterior.getFullYear() - 1
      );
      dataInicioAnoAnterior = dataInicioAnoAnterior.toISOString().split("T")[0];

      let dataFimAnoAnterior = new Date(dataFim);
      dataFimAnoAnterior.setFullYear(dataFimAnoAnterior.getFullYear() - 1);
      dataFimAnoAnterior = dataFimAnoAnterior.toISOString().split("T")[0];

      fetch(
        `/concessionaria/acidentePorMes?fkConcessionaria=${fkConcessionaria}&dataInicio=${dataInicioAnoAnterior}&dataFim=${dataFimAnoAnterior}`
      ).then((response) => {
        response.json().then((anoAAnterior) => {
          renderizarAcidentesDoAnoAnterior(anoAtual, anoAAnterior);
        });
      });
    });
  });

  function renderizarAcidentesDoAnoAnterior(atual, anoAnterior) {
    const urlParams = new URLSearchParams(window.location.search);

    const dataInicio = new Date(urlParams.get("dataInicio"));
    dataInicio.setDate(dataInicio.getDate() + 1);

    const dataFim = new Date(urlParams.get("dataFim"));
    dataFim.setDate(dataFim.getDate() + 1);

    const meses = [];
    const mesInicio = dataInicio.getMonth();
    const mesFim = dataFim.getMonth();

    const mesesNoAno = [
      "Janeiro",
      "Fevereiro",
      "Março",
      "Abril",
      "Maio",
      "Junho",
      "Julho",
      "Agosto",
      "Setembro",
      "Outubro",
      "Novembro",
      "Dezembro",
    ];

    for (let i = mesInicio; i <= mesFim; i++) {
      meses.push(mesesNoAno[i]);
    }

    console.log(atual, anoAnterior);
    // 2. DADOS: Duas séries, uma para cada ano
    const dadosAcidentes = {
      labels: meses,
      datasets: [
        {
          label: `Ano passado (${dataInicio.getFullYear() - 1})`, // Linha 1: Período de 5 meses do ano passado
          data: anoAnterior.map((item) => item.quantidade), // Valores de acidentes para os 5 meses
          borderColor: "rgb(54, 162, 235)", // Cor Azul
          backgroundColor: "rgba(54, 162, 235, 0.5)",
          tension: 0.3,
          fill: false,
        },
        {
          label: `Ano Atual (${dataInicio.getFullYear()})`, // Linha 2: Período de 5 meses do ano atual
          data: atual.map((item) => item.quantidade), // Valores de acidentes para os mesmos 5 meses
          borderColor: "rgb(255, 99, 132)", // Cor Vermelha
          backgroundColor: "rgba(255, 99, 132, 0.5)",
          tension: 0.3,
          fill: false,
        },
      ],
    };

    console.log(dataInicio, dataFim);
    // 3. CONFIGURAÇÃO DO GRÁFICO
    const configuracao = {
      type: "line",
      data: dadosAcidentes,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: 10 },
        plugins: {
          legend: {
            position: "top", // Legenda no topo
          },
          title: {
            display: true,
            text: `Acidentes de ${
              dataInicio.getMonth() + 1
            }/${dataInicio.getFullYear()} a ${
              dataFim.getMonth() + 1
            }/${dataFim.getFullYear()}`,
            font: {
              size: 20,
              weight: "bold",
            },
            color: "#010358",
          },
        },
      },
    };

    const ctx4 = document.getElementById("myChart4");
    new Chart(ctx4, configuracao);
  }

  fetch(
    "/concessionaria/gravidadeDasVitimas?fkConcessionaria=" + fkConcessionaria
  ).then((response) => {
    response.json().then((data) => {
      const ctx2 = document.getElementById("myChart2");

      const { quantidadeFatal, quantidadeGrave, quantidadeLeve } = data[0];

      const meuGraficoPizza = new Chart(ctx2, {
        type: "pie",
        data: {
          labels: ["Fatal", "Grave", "Leve"],
          datasets: [
            {
              data: [quantidadeFatal, quantidadeGrave, quantidadeLeve],
              backgroundColor: ["#6ce5e8", "#41b8d5", "#2d8bba"],
              borderWidth: 1,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false, // permite que o gráfico se ajuste à div
          plugins: {
            title: {
              display: true,
              text: "Gravidade das vítimas",
              position: "top", // título acima do gráfico
              font: {
                size: 20,
                weight: "bold",
              },
              color: "white",
            },
            legend: {
              display: true,
              position: "bottom", // legenda abaixo do gráfico
              labels: {
                color: "white",
                usePointStyle: true, // bolinhas em vez de retângulos, ajuda a economizar espaço
                padding: 20, // espaço entre legendas
                boxWidth: 20, // largura da caixa da legenda
              },
              // Força a legenda a ser horizontal
              align: "center",
              fullSize: false,
            },
          },
        },
        plugins: [
          {
            id: "customLabels",
            afterDatasetsDraw(chart) {
              const { ctx } = chart;
              const meta = chart.getDatasetMeta(0);

              // calcula o total apenas das fatias visíveis
              const visibleTotal = meta.data.reduce((acc, element, i) => {
                if (!element.hidden) {
                  acc += parseFloat(chart.data.datasets[0].data[i]);
                }
                return acc;
              }, 0);

              meta.data.forEach((element, index) => {
                if (element.hidden) return; // não desenha se a fatia estiver oculta

                const { x, y } = element.tooltipPosition();
                ctx.save();
                ctx.fillStyle = "black";
                ctx.font = "14px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "bottom";

                const value = chart.data.datasets[0].data[index];
                const percentage =
                  ((value / visibleTotal) * 100).toFixed(1) + "%";

                ctx.fillText(percentage, x, y - 10);
                ctx.restore();
              });
            },
          },
        ],
      });
    });
  });

  fetch(
    "/concessionaria/tipoDePista?fkConcessionaria=" + fkConcessionaria
  ).then((response) => {
    response.json().then((data) => {
      const quantidade = [];
      const tipoPista = [];

      data.forEach((tipo) => {
        quantidade.push(tipo.quantidade);
        tipoPista.push(tipo.tipoPista);
      });

      const MIN = 2;

      if (tipoPista.length > MIN) {
        let somaOutros = 0;
        for (let i = MIN; i < quantidade.length; i++) {
          somaOutros += quantidade[i];
        }
        quantidade.splice(MIN, quantidade.length - MIN);
        quantidade.push(somaOutros);

        tipoPista.splice(MIN, tipoPista.length - MIN);
        tipoPista.push("Outros");
      }

      const ctx3 = document.getElementById("myChart3");

      const meuGraficoPizza3 = new Chart(ctx3, {
        type: "pie",
        data: {
          labels: tipoPista,
          datasets: [
            {
              data: quantidade,
              backgroundColor: ["#6ce5e8", "#41b8d5", "#41b5b5", "#2d8bba"],
              borderWidth: 1,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: "Tipos de pista",
              position: "top",
              font: {
                size: 20,
                weight: "bold",
              },
              color: "white",
            },
            legend: {
              display: true,
              position: "bottom",
              labels: {
                color: "white",
                usePointStyle: true, // bolinhas em vez de retângulos, ajuda a economizar espaço
                padding: 20, // espaço entre legendas
                boxWidth: 20, // largura da caixa da legenda
              },
              // Força a legenda a ser horizontal
              align: "center",
              fullSize: false,
            },
          },
        },
        plugins: [
          {
            id: "customLabels",
            afterDatasetsDraw(chart) {
              const { ctx } = chart;
              const meta = chart.getDatasetMeta(0);

              // calcula o total apenas das fatias visíveis
              const visibleTotal = meta.data.reduce((acc, element, i) => {
                if (!element.hidden) {
                  acc += parseFloat(chart.data.datasets[0].data[i]);
                }
                return acc;
              }, 0);

              meta.data.forEach((element, index) => {
                if (element.hidden) return; // não desenha se a fatia estiver oculta

                const { x, y } = element.tooltipPosition();
                ctx.save();
                ctx.fillStyle = "black";
                ctx.font = "14px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "bottom";

                const value = chart.data.datasets[0].data[index];
                const percentage =
                  ((value / visibleTotal) * 100).toFixed(1) + "%";

                ctx.fillText(percentage, x, y - 10);
                ctx.restore();
              });
            },
          },
        ],
      });
    });
  });
</script>
