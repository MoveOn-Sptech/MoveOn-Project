<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Perfil Operacional</title>

    <link rel="stylesheet" href="css/perfil.css" />
    <link rel="icon" href="assets/icon/volante_MoveOn.png" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>

<body>

    <nav>

        <span class="logo_nav">
            <a href="perfil.html"><img src="../assets/logo_branca.png" alt=""></a>
        </span>
        <span class="user_icon">
            <a href="perfil.html"><img src="assets/icon/user-dash.png" alt=""></a>
        </span>

    </nav>

    <section class="geral_main">

        <div class="nome_usuario">
            <h1></h1>
            <h3>Perfil Estratégico</h3>
        </div>

        <div class="card_rodovias">
            <h1>Informações pessoais</h1>

            <p class="info" id="info_cargo"><b>Cargo: </b></p>
            <p class="info" id="info_email"><b>Email: </b></p>

            <p class="acessar">Acessar:</p>

            <div class="links_acesso">
                <a class="link" href="dashboard/visao-geral-rodovia.html"><button>Rodovias</button></a>
                <a class="link" href="dashboard/visao-geral-concessionaria.html"><button>Concessionárias</button></a>
            </div>
        </div>

        <div class="action_buttons_container">
            <button class="action_btn" onclick="abrirModal('modal_editar_info')">Editar Informações</button>
            <button class="action_btn" onclick="abrirModal('modal_lista_usuarios')">Ver usuários</button>
            <button class="action_btn" onclick="abrirModal('modal_pesquisa_rodovia')">Editar rodovia</button>
        </div>

    </section>

    <section id="modal_editar_info" class="tela_modal">
        <div class="card_modal modal_large">

            <img onclick="fecharModal('modal_editar_info')" class="x" src="assets/icon/X.png" alt="">

            <h1>Editar informações</h1>

            <div class="form_grid grid_2_col">
                <div class="input_group">
                    <label>Nome atual</label>
                    <input type="text" value="Mariana Albuquerque">
                </div>
                <div class="input_group">
                    <label>Novo nome</label>
                    <input type="text">
                </div>

                <!-- <div class="input_group">
                    <label>Cargo atual</label>
                    <input type="text" value="Diretora de planejamento">
                </div>
                <div class="input_group">
                    <label>Novo cargo</label>
                    <input type="text">
                </div> -->

                <div class="input_group">
                    <label>Email atual</label>
                    <input type="text" value="albuquerquemari@artesp.com.br">
                </div>
                <div class="input_group">
                    <label>Novo email</label>
                    <input type="text">
                </div>
            </div>

            <div class="modal_buttons">
                <button class="btn_save btn_salvarInfos" onclick="fecharModal('modal_editar_info')">Salvar</button>
                <button class="btn_cancel" onclick="fecharModal('modal_editar_info')">Cancelar</button>
            </div>
        </div>
    </section>

    <section id="modal_lista_usuarios" class="tela_modal">
        <div class="card_modal modal_large">
            <div class="modal_header_controls">
                <img onclick="fecharModal('modal_lista_usuarios')" class="x" src="assets/icon/X.png" alt="">
            </div>

            <h1>Lista de usuários</h1>

            <div class="list_header">
                <span class="col_nome">Nome</span>
                <span class="col_cargo">Cargo</span>
            </div>

            <div class="user_list">
                <!-- <div class="user_item">
                    <div class="user_info">
                        <div class="user_name">Fernando Oliveira</div>
                        <div class="separator"></div>
                        <div class="user_role">Técnico de monitoramento</div>
                    </div>
                    <div class="user_actions">
                        <img onclick="abrirEditarUsuario('Fernando Oliveira')" class="icon_action"
                            src="assets/icon/lapis.png" alt="Editar">
                        <img onclick="abrirConfirmarDelecao()" class="icon_action" src="assets/icon/lixeira.png"
                            alt="Excluir">
                    </div>
                </div> -->
            </div>
        </div>
    </section>

    <section id="modal_editar_usuario_unico" class="tela_modal" style="z-index: 1100;">
        <div class="card_modal modal_large">
            <div class="close_icon" onclick="fecharModal('modal_editar_usuario_unico')"><i
                    class="fa-solid fa-xmark"></i></div>

            <h1>Editar usuário</h1>

            <div class="form_grid grid_2_col">
                <div class="input_group">
                    <label>Nome</label>
                    <input type="text" id="input_nome_user_edit" readonly
                        style="background-color: rgba(255,255,255,0.8); color: #010358; font-weight: bold;">
                </div>
                <div class="input_group">
                    <label>Cargo</label>
                    <input type="text" value="Técnico de monitoramento" readonly
                        style="background-color: rgba(255,255,255,0.8); color: #010358;">
                </div>

                <div class="input_group">
                    <label>Alterar cargo</label>
                    <input type="text">
                </div>
                <div class="input_group">
                    <label>Alterar email</label>
                    <input type="text">
                </div>
            </div>

            <div class="modal_buttons">
                <button class="btn_save" onclick="editarInfosUnicas()">Salvar</button>
                <button class="btn_cancel" onclick="fecharModal('modal_editar_usuario_unico')">Cancelar</button>
            </div>
        </div>
    </section>

    <section id="modal_confirmar_delecao" class="tela_modal" style="z-index: 1200;">
        <div class="card_modal modal_small">
            <h2>Deseja remover o usuário?</h2>
            <div class="modal_buttons" style="margin-top: 20px;">
                <button class="btn_save" onclick="deletarUsuario()">Confirmar</button>
                <button class="btn_cancel" onclick="fecharModal('modal_confirmar_delecao')">Cancelar</button>
            </div>
        </div>
    </section>

    <section id="modal_pesquisa_rodovia" class="tela_modal">
        <div class="card_modal modal_medium">
            <div class="close_icon" onclick="fecharModal('modal_pesquisa_rodovia')"><i class="fa-solid fa-xmark"></i>
            </div>

            <h1>Editar rodovia</h1>

            <div class="form_grid grid_1_col">
                <div class="input_group">
                    <label style="text-align: center;">Pesquisar rodovia</label>
                    <input type="text" placeholder="Ex: Anhanguera" id="input_busca_rodovia">
                </div>
            </div>

            <div class="modal_buttons">
                <button class="btn_save" onclick="avancarParaDadosRodovia()">Pesquisar</button>
                <button class="btn_cancel" onclick="fecharModal('modal_pesquisa_rodovia')">Cancelar</button>
            </div>
        </div>
    </section>

    <section id="modal_dados_rodovia" class="tela_modal">
        <div class="card_modal modal_large">
            <div class="close_icon" onclick="fecharModal('modal_dados_rodovia')"><i class="fa-solid fa-xmark"></i></div>

            <h1>Nome da rodovia</h1>

            <div class="form_grid grid_2_col">
                <div class="input_group">
                    <label>Denominação</label>
                    <input type="text" value="ANHANGUERA">
                </div>
                <div class="input_group">
                    <label>Concessionária</label>
                    <input type="text" value="ANHANGUERA">
                </div>

                <div class="input_group">
                    <label>Regional ADM</label>
                    <input type="text" value="Regional">
                </div>
                <div class="input_group">
                    <label>Regional DER</label>
                    <input type="text" value="Campinas">
                </div>
            </div>

            <div class="modal_buttons">
                <button class="btn_save" onclick="fecharModal('modal_dados_rodovia')">Confirmar</button>
                <button class="btn_cancel" onclick="fecharModal('modal_dados_rodovia')">Cancelar</button>
            </div>
        </div>
    </section>

    <section id="modal_confirmar_delecao" class="tela_modal">
        <div class="card_modal modal_small centered_content">
            <h2 class="modal_title">Deseja remover o usuário?</h2>

            <div class="modal_buttons">
                <button class="btn_modal btn_primary" onclick="alert('Usuário removido!')">Confirmar</button>

                <button class="btn_modal btn_secondary"
                    onclick="fecharModal('modal_confirmar_delecao')">Cancelar</button>
            </div>
        </div>

    </section>

    <script>

        var nomes = document.querySelector(".nome_usuario");
        var info_cargo = document.querySelector("#info_cargo");
        var infoEmail = document.querySelector("#info_email");

        var nome = sessionStorage.getItem("nomeUsuario");
        var cargo = sessionStorage.getItem("cargoUsuario");
        var emailBd = sessionStorage.getItem("emailUsuario");

        nomes.innerHTML = `
        <h1>${nome}</h1>
        <h3>Perfil ${cargo}</h3>
        `;

        infoEmail.innerHTML = `
        <p class="info" id="info_email"><b>Email: ${emailBd}</b></p>
        `;

        info_cargo.innerHTML = `
        <p class="info" id="info_cargo"><b>Cargo: ${cargo}</b></p>
        `;

        function abrirModal(id) {
            const modal = document.getElementById(id);
            modal.style.display = "flex";
            modal.classList.remove("fechando");
        }

        function fecharModal(id) {
            const modal = document.getElementById(id);
            modal.classList.add("fechando");
            setTimeout(() => {
                modal.style.display = "none";
                modal.classList.remove("fechando");
            }, 300);
        }

        function abrirEditarUsuario(nome) {
            document.getElementById('input_nome_user_edit').value = nome;
            abrirModal('modal_editar_usuario_unico');
        }

        var idUsuario;
        function abrirConfirmarDelecao(elementoClicado) {
            abrirModal('modal_confirmar_delecao');

            const cardUsuario = elementoClicado.closest('.user_item');

            // Pega o valor do atributo 'value'
            idUsuario = cardUsuario.getAttribute('value');

            console.log(idUsuario);


        }

        function deletarUsuario() {

            fetch("/usuarios/deletar", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    idUsuarioVar: idUsuario
                }),
            })
                .then((response) => {
                    if (response.ok) {

                        response.json().then((data) => {

                            console.log(data);

                            fecharModal();

                            Swal.fire({
                                icon: "success",
                                title: "Sucesso",
                                text: "Usuário deletado!",
                            })

                        })

                    } else {
                        return response.json().then((data) => {
                            //throw new Error(data.message || "Erro ao deletar.");

                            Swal.fire({
                                icon: "error",
                                title: "Erro",
                                text:
                                    "Usuário inválido!"
                            });

                        });
                    }
                })
                .catch((error) => {
                    console.log(error);

                });
        }



        function avancarParaDadosRodovia() {
            fecharModal('modal_pesquisa_rodovia');

            setTimeout(() => {
                abrirModal('modal_dados_rodovia');
            }, 300);
        }

        window.onclick = function (event) {
            if (event.target.classList.contains('tela_modal')) {
                fecharModal(event.target.id);
            }
        }

        function pegarUsuarios() {

            var lista = document.querySelector(".user_list");

            fetch("/usuarios/listarUsuarios", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                }),
            })
                .then((response) => {
                    if (response.ok) {

                        response.json().then(data => {

                            console.log(data);

                            for (let i = 0; i < data.nome.length; i++) {

                                lista.innerHTML += `
                                
                                <div class="user_item" value="${data.id[i]}">
                    <div class="user_info">
                        <div class="user_name">${data.nome[i]}</div>
                        <div class="separator"></div>
                        <div class="user_role">${data.cargo[i]}</div>
                    </div>
                    <div class="user_actions">
                        <img onclick="abrirEditarUsuario('${data.nome[i]}')" class="icon_action"
                            src="assets/icon/lapis.png" alt="Editar">
                        <img onclick="abrirConfirmarDelecao(this)" class="icon_action" src="assets/icon/lixeira.png"
                            alt="Excluir">
                    </div>
                </div>

                                `;

                            }

                        })

                    } else {
                        return response.json().then((data) => {
                            throw new Error(data.message || "Erro ao autenticar.");
                        });
                    }
                })
                .catch((error) => {
                    console.log(error);

                });
        }

        pegarUsuarios();

        // <div class="card_modal modal_large">

        //     <img onclick="fecharModal('modal_editar_info')" class="x" src="assets/icon/X.png" alt="">

        //         <h1>Editar informações</h1>

        //         <div class="form_grid grid_2_col">
        //             <div class="input_group">
        //                 <label>Nome atual</label>
        //                 <input type="text" value="Mariana Albuquerque">
        //             </div>
        //             <div class="input_group">
        //                 <label>Novo nome</label>
        //                 <input type="text">
        //             </div>

        //         <!-- <div class="input_group">
        //                 <label>Cargo atual</label>
        //                 <input type="text" value="Diretora de planejamento">
        //             </div>
        //             <div class="input_group">
        //                 <label>Novo cargo</label>
        //                 <input type="text">
        //             </div> -->

        //             <div class="input_group">
        //                 <label>Email atual</label>
        //                 <input type="text" value="albuquerquemari@artesp.com.br">
        //             </div>
        //             <div class="input_group">
        //                 <label>Novo email</label>
        //                 <input type="text">
        //             </div>
        //         </div>

        //         <div class="modal_buttons">
        //             <button class="btn_save btn_salvarInfos" onclick="fecharModal('modal_editar_info')">Salvar</button>
        //             <button class="btn_cancel" onclick="fecharModal('modal_editar_info')">Cancelar</button>
        //         </div>
        // </div>


        function editarInfosUnicas() {

            var valorNome = document.querySelector(".novoNomeUsuario").value;
            var valorEmail = document.querySelector(".novoEmailUsuario").value;

            var idUsuario = sessionStorage.getItem("idUsuario")

            const body = { idUsuarioVar: idUsuario }

            if (nomeInput.value.trim() !== "") {
                body.nome = nomeInput.value.trim();
            }

            if (emailInput.value.trim() !== "") {
                body.email = emailInput.value.trim();
            }

            fetch("/usuarios/editar", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    body
                }),
            })
                .then((response) => {
                    if (response.ok) {

                        response.json().then((data) => {

                            console.log(data);

                            fecharModal('modal_editar_usuario_unico')
                            Swal.fire({
                                icon: "success",
                                title: "Sucesso",
                                text: "Usuário editado!",
                            })

                        })

                    } else {
                        return response.json().then((data) => {

                            Swal.fire({
                                icon: "error",
                                title: "Erro",
                                text:
                                    "Usuário inválido!"
                            });

                        });
                    }
                })
                .catch((error) => {
                    console.log(error);

                });

        }

    </script>
</body>

</html>